Index: something
=================
--- a/skins/default/css.txt	2022-03-29 20:18:24.801335743 +0200
+++ b/skins/default/css.txt	2022-03-29 20:21:30.299997246 +0200
@@ -1,3 +1,39 @@
+/* My */
+
+li.file {
+  display: flex;
+  flex-direction: row;
+}
+
+li.dir {
+  display: flex;
+  flex-direction: row;
+}
+
+.file-comment {
+  text-overflow: ellipsis;
+  white-space: nowrap;
+  overflow: hidden;
+  width: 60%;
+}
+
+li.file > a {
+  width: 20%;
+}
+
+li.dir > a {
+  width: 20%;
+}
+
+.file-date {
+  width: 20%;
+}
+
+.columns {
+  columns: unset !important;
+}
+
+
 /* Overall page style */
 
 body {

--- a/src/browse.c	2022-03-29 20:21:25.678931982 +0200
+++ b/src/browse.c	2022-03-29 20:21:30.331997698 +0200
@@ -269,8 +269,21 @@
   ** from directories in the loop that follows.
   */
   db_multi_exec(
-     "CREATE TEMP TABLE localfiles(x UNIQUE NOT NULL, u);"
+     "CREATE TEMP TABLE localfiles(basename UNIQUE NOT NULL, uuid, pathname);"
   );
+
+  /* Latest commit message and timestamp for EVERY file */
+  db_multi_exec(
+     "create temp table latestchanges as\n"
+     "select f.name as name, e.comment, e.mtime as d\n"
+     "from filename f, event e, mlink m\n"
+     "where f.fnid=m.fnid\n"
+     "and e.objid=m.mid\n"
+     "and e.type='ci'\n"
+     "group by name,d\n"
+     "order by d desc"
+  );
+
   if( zCI ){
     Stmt ins;
     ManifestFile *pFile;
@@ -279,7 +292,7 @@
     int c;
 
     db_prepare(&ins,
-       "INSERT OR IGNORE INTO localfiles VALUES(pathelement(:x,0), :u)"
+       "INSERT OR IGNORE INTO localfiles VALUES(pathelement(:b,0), :u, :p)"
     );
     manifest_file_rewind(pM);
     while( (pFile = manifest_file_next(pM,0))!=0 ){
@@ -295,8 +308,9 @@
       ){
         continue;
       }
-      db_bind_text(&ins, ":x", &pFile->zName[nD]);
+      db_bind_text(&ins, ":b", &pFile->zName[nD]);
       db_bind_text(&ins, ":u", pFile->zUuid);
+      db_bind_text(&ins, ":p", pFile->zName);
       db_step(&ins);
       db_reset(&ins);
       pPrev = pFile;
@@ -307,14 +321,14 @@
   }else if( zD ){
     db_multi_exec(
       "INSERT OR IGNORE INTO localfiles"
-      " SELECT pathelement(name,%d), NULL FROM filename"
+      " SELECT pathelement(name,%d), NULL, name FROM filename"
       "  WHERE name GLOB '%q/*'",
       nD, zD
     );
   }else{
     db_multi_exec(
       "INSERT OR IGNORE INTO localfiles"
-      " SELECT pathelement(name,0), NULL FROM filename"
+      " SELECT pathelement(name,0), NULL, name FROM filename"
     );
   }
 
@@ -322,26 +336,46 @@
   ** do not match the pattern */
   if( zRegexp ){
     db_multi_exec(
-      "DELETE FROM localfiles WHERE x NOT REGEXP %Q", zRegexp
+      "DELETE FROM localfiles WHERE basename NOT REGEXP %Q", zRegexp
     );
   }
 
   /* Generate a multi-column table listing the contents of zD[]
   ** directory.
   */
-  mxLen = db_int(12, "SELECT max(length(x)) FROM localfiles /*scan*/");
+  mxLen = db_int(12, "SELECT max(length(basename)) FROM localfiles /*scan*/");
   if( mxLen<12 ) mxLen = 12;
   mxLen += (mxLen+9)/10;
   db_prepare(&q, 
-     "SELECT x, u FROM localfiles ORDER BY x COLLATE uintnocase /*scan*/");
+     "SELECT basename, uuid, pathname FROM localfiles ORDER BY basename COLLATE uintnocase /*scan*/");
   @ <div class="columns files" style="columns: %d(mxLen)ex auto">
   @ <ul class="browser">
   while( db_step(&q)==SQLITE_ROW ){
     const char *zFN;
     zFN = db_column_text(&q, 0);
+    const char *pathname = db_column_text(&q, 2);
+    Stmt q2;
     if( zFN[0]=='/' ){
       zFN++;
-      @ <li class="dir">%z(href("%s%T",zSubdirLink,zFN))%h(zFN)</a></li>
+      // can calculate dir name from ?name + basename
+
+      if (zD) {
+        db_prepare(&q2, "select * from latestchanges where name like '%q/%q%%'",zD,zFN);
+      } else {
+        db_prepare(&q2, "select * from latestchanges where name like '%q%%'",zFN);
+      }
+
+      if (db_step(&q2)==SQLITE_ROW) {
+        const char *comment   = db_column_text(&q2, 1);
+        double timestamp = db_column_double(&q2, 2);
+        double now = db_double(0.0, "SELECT (julianday('now'))");
+        char *human_timestamp = human_readable_age(now - timestamp);
+        @ <li class="dir">%z(href("%s%T",zSubdirLink,zFN))%h(zFN)</a><div class="file-comment">%s(comment)</div><div class="file-date">%s(human_timestamp)</div></li>
+        free(human_timestamp);
+      } else {
+        @ <li class="dir">%z(href("%s%T",zSubdirLink,zFN))%h(zFN)</a><div class="file-comment"></div>%s(zD)<div class="file-date">%s(zFN)</div></li>
+      }
+
     }else{
       const char *zLink;
       if( zCI ){
@@ -349,8 +383,19 @@
       }else{
         zLink = href("%R/finfo?name=%T%T",zPrefix,zFN);
       }
-      @ <li class="%z(fileext_class(zFN))">%z(zLink)%h(zFN)</a></li>
+      db_prepare(&q2, "select * from latestchanges where name='%q'",pathname);
+      if (db_step(&q2)==SQLITE_ROW) {
+        const char *comment   = db_column_text(&q2, 1);
+        double timestamp = db_column_double(&q2, 2);
+        double now = db_double(0.0, "SELECT (julianday('now'))");
+        char *human_timestamp = human_readable_age(now - timestamp);
+        @ <li class="%z(fileext_class(zFN))">%z(zLink)%h(zFN)</a><div class="file-comment">%s(comment)</div><div class="file-date">%s(human_timestamp)</div></li>
+        free(human_timestamp);
+      } else {
+        @ <li class="%z(fileext_class(zFN))">%z(zLink)%h(zFN)</a><div class="file-comment">%s(pathname)</div><div class="file-date"></div></li>
+      }
     }
+    db_finalize(&q2);
   }
   db_finalize(&q);
   manifest_destroy(pM);
@@ -368,10 +413,10 @@
   ** the list of files
   */
   db_prepare(&q,
-    "SELECT x, u FROM localfiles"
-    " WHERE x COLLATE nocase IN"
+    "SELECT basename, uuid FROM localfiles"
+    " WHERE basename COLLATE nocase IN"
     " ('readme','readme.txt','readme.md','readme.wiki','readme.markdown',"
-    " 'readme.html') ORDER BY x COLLATE uintnocase LIMIT 1;"
+    " 'readme.html') ORDER BY basename COLLATE uintnocase LIMIT 1;"
   );
   if( db_step(&q)==SQLITE_ROW ){
     const char *zName = db_column_text(&q,0);
@@ -1034,13 +1079,13 @@
       return mprintf("%d seconds", (int)(rAge*86400.0));
     }
   }else if( rAge*1440.0<90 ){
-    return mprintf("%.1f minutes", rAge*1440.0);
+    return mprintf("%.0f minutes", rAge*1440.0);
   }else if( rAge*24.0<36 ){
-    return mprintf("%.1f hours", rAge*24.0);
+    return mprintf("%.0f hours", rAge*24.0);
   }else if( rAge<365.0 ){
-    return mprintf("%.1f days", rAge);
+    return mprintf("%.0f days", rAge);
   }else{
-    return mprintf("%.2f years", rAge/365.2425);
+    return mprintf("%.1f years", rAge/365.2425);
   }
 }
 